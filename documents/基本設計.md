1. **30秒要点**

* このアプリは「1つの MCP サーバー（Node + SQLite）＋ 1つの React ウィジェット」で構成します。
* サーバー側は「日記・やりたいこと・週間タスク・行動分析」を SQLite で管理し、各カードごとに MCP ツール（API）を定義します。
* フロント側は `@openai/apps-sdk-ui` の 4つのカードコンポーネントで構成し、`window.openai.callTool` で MCP ツールを呼び出して更新します。

---

2. **手順（＝今回の基本設計の中身）**

### 手順1：全体アーキテクチャを決める

何がどこで動くかをはっきりさせます。

* ChatGPT クライアント側

  * ChatGPT の画面＋右側に表示されるウィジェット（React）
  * `window.openai.toolOutput` に MCP ツールの結果が入り、`window.openai.callTool()` でサーバーのツールを呼び出す（Quickstart の Todo サンプルと同じ流れ）([OpenAI Developers][1])

* MCP サーバー（Node.js）

  * `@modelcontextprotocol/sdk` を使った `McpServer`
  * SQLite に接続し、以下のツールを提供

    * 日記系：読み込み・保存・タグ更新・タグ自動生成
    * やりたいこと：一覧・追加・完了・削除
    * 週間タスク：一覧・追加・完了・削除
    * 行動分析：分析実行（GPT）・分析結果保存・履歴一覧
    * 初期表示用：ダッシュボード全体読み込み

* DB（SQLite）

  * `diaries`, `todos`, `weekly_tasks`, `analyses` の 4 テーブル
  * サーバーからのみアクセス。フロントは直接触らない。

* アプリ構成（ディレクトリ案）

  * `server/`

    * `server.ts`：McpServer 初期化＋ツール登録
    * `db.ts`：SQLite 接続とテーブル作成
    * `repositories/`：DB CRUD ロジック
    * `services/`：タグ生成・行動分析など GPT 連携ロジック
    * `types.ts`：共通の型定義
  * `web/`

    * `src/App.tsx`：4カードを縦に並べるメインコンポーネント
    * `src/components/DiaryCard.tsx`
    * `src/components/WeeklyTasksCard.tsx`
    * `src/components/TodosCard.tsx`
    * `src/components/AnalysisCard.tsx`

---

### 手順2：DB 設計（テーブル定義）を固める

要件定義の §4 を、そのまま「CREATE TABLE」として落とします（細かい制約を追加）。

* `diaries`
  * 主キー `id`
  * `date` は一意制約（1日1レコード）
  * `content` は空文字でも OK
  * `tag1`〜`tag5` は NULL 許可
  * `created_at`, `updated_at` は ISO 文字列で保存

* `todos`
  * `title` はやりたいことの名前
  * `is_done` は 0/1（BOOLEAN）

* `weekly_tasks`
  * `title` は週間タスクの名前
  * `is_done` は 0/1（BOOLEAN）

* `analyses`
  * `period_type` は `"week"` / `"month"`
  * `start_date`, `end_date` は日付文字列
  * `summary` に分析結果を全文保存

（実際の DDL は後の「コピペ用ブロック」に記載します）

---

### 手順3：MCP ツール（＝サーバー側 API）設計

Quickstart の `add_todo` / `complete_todo` のように、機能ごとにツールを切り出します。([OpenAI Developers][1])

#### 3-1. 共通：初期表示ツール

* ツール名：`load_dashboard`
* 入力

  * `date`（オプション、指定なければ今日）
* 出力（structuredContent）

  * `diary`: 指定日の日記（なければ空のテンプレ）
  * `todos`: やりたいこと一覧
  * `weeklyTasks`: 登録タスク一覧
  * `analysisHistory`: 直近5件の分析履歴

→ ウィジェット初期表示時は、この structuredContent を `window.openai.toolOutput` として受け取り、各カードに渡します。

#### 3-2. 今日の日記カード関連

* F-1〜F-5 を以下のツールでカバー

1. `get_diary_by_date`

   * 入力：`{ date: string }`
   * 出力：`{ diary }`
   * 役割：日付変更時に該当日記をロード

2. `save_diary`

   * 入力：`{ date: string, content: string, tags?: string[] }`
   * 動作：

     * `diaries` に該当日付があれば `UPDATE`、なければ `INSERT`
     * `tags` が省略なら、内容からタグ自動生成サービスを呼ぶ（後述） ????
   * 出力：

     * `structuredContent.diary`：保存後の内容
     * `content`：ユーザー向けメッセージ（例：「日記を保存しました」）

3. `update_diary_tags`

   * 入力：`{ date: string, tags: string[] }`
   * 動作：指定日付レコードの `tag1`〜`tag5` を更新
   * 出力：`structuredContent.diary`

4. `update_diary_content`

   * 入力：`{ date: string, content: string }`
   * 動作：本文のみ更新（「反映」ボタン用）
   * 出力：`structuredContent.diary`

5. `generate_diary_tags`

   * 入力：`{ content: string }`
   * 動作：GPT を呼び出し、最大5つのタグを返す
   * 出力：`structuredContent.tags: string[]`
   * 注意：DB への保存は別ツール（`update_diary_tags`）で行う設計にしてもよい

#### 3-3. やりたいことカード（F-9〜F-11）

1. `list_todos`

   * 入力：なし
   * 出力：`structuredContent.todos: Todo[]`

2. `add_todo`

   * 入力：`{ title: string }`
   * 動作：`todos` に INSERT
   * 出力：更新後の `todos`

3. `set_todo_done`

   * 入力：`{ id: number, is_done: boolean }`
   * 出力：更新後の `todos`

4. `delete_todo`

   * 入力：`{ id: number }`
   * 出力：更新後の `todos`

※ Quickstart の Todo サンプルとほぼ同じ構成です。([OpenAI Developers][1])

#### 3-4. 週間タスクリストカード（F-6〜F-8）

1. `list_weekly_tasks`

   * 入力：なし
   * 出力：`structuredContent.weeklyTasks: WeeklyTask[]`

2. `add_weekly_task`

   * 入力：`{ title: string }`
   * 動作：`weekly_tasks` に INSERT
   * 出力：更新後の `weekly_tasks`

3. `set_weekly_task_done`

   * 入力：`{ id: number, is_done: boolean }`
   * 出力：更新後の `weekly_tasks`

4. `delete_weekly_task`

   * 入力：`{ id: number }`   
   * 出力：更新後の `weekly_tasks`

#### 3-5. 行動分析カード（F-12〜F-15）

1. `run_analysis`

   * 入力：

     * `period_type: "week" | "month"`
     * `start_date: string`
   * サーバー側処理：

     * 該当期間の `diaries`を SELECT
     * GPT に投げるためのプロンプトテキストを組み立て
     * GPT から分析テキストを受け取る
   * 出力：

     * `structuredContent.analysisDraft: { period_type, start_date, end_date, summary }`

2. `save_analysis`

   * 入力：`{ period_type, start_date, end_date, summary }`
   * 動作：`analyses` に INSERT
   * 出力：

     * `structuredContent.lastSavedAnalysis`
     * `structuredContent.analysisHistory`（直近5件を再取得）

3. `list_analyses`

   * 入力：`{ limit?: number, offset?: number }`
   * 出力：`structuredContent.analysisHistory`

---

### 手順4：React + Apps SDK UI のコンポーネント設計

`@openai/apps-sdk-ui` の `Card`, `Button`, `Textarea`, `Input`, `Checkbox` などを使い、以下を構成します。([GitHub][2])

#### 4-1. App レベル

* `<JournalCoachApp />`

  * props：`initialData`（`load_dashboard` の structuredContent）
  * 内部で状態を持つ：

    * `selectedDate`
    * `diary`
    * `todos`
    * `weeklyTasks`
    * `analysisDraft`
    * `analysisHistory`

* マウント時：

  * `window.openai?.toolOutput` を読んで `initialData` としてセット
  * ない場合はローカル仮データでも動くようにしておく（デバッグ用）

#### 4-2. カードごとのコンポーネント（例）

* `<DiaryCard />`

  * props：

    * `date`
    * `diary`
    * `onChangeDate(date)`
    * `onSave(content, tags)`
    * `onGenerateTags(content)`
    * `onUpdateContent(content)`
  * UI：

    * 日付ドロップダウン
    * 日記テキストエリア
    * タグ編集用の小さな入力欄×5
    * 「反映」「タグ自動生成」ボタン

* `<TodosCard />`

  * props：`todos`, `onAdd`, `onToggleDone`, `onDelete`
  * UI：チェックボックス付きリスト＋追加入力欄

* `<WeeklyTasksCard />`

  * props：`weeklyTasks`, `onAdd`, `onToggleDone`, `onDelete`
  * UI：チェックボックス付きリスト＋追加入力欄

* `<AnalysisCard />`

  * props：

    * `analysisDraft`
    * `analysisHistory`
    * `onRunAnalysis({ period_type, start_date })`
    * `onSaveAnalysis(draft)`
    * `onSelectHistoryItem(item)`

#### 4-3. MCP ツール呼び出しパターン

Quickstart と同様に、各カード内で以下のように呼び出すイメージです。([OpenAI Developers][1])

* 例：日記保存ボタン押下時

```ts
const saveDiary = async (date: string, content: string, tags: string[]) => {
  if (!window.openai?.callTool) return;
  const response = await window.openai.callTool("save_diary", {
    date,
    content,
    tags,
  });
  const diary = response?.structuredContent?.diary;
  if (diary) {
    setDiary(diary);
  }
};
```

---

### 手順5：GPT 連携（タグ生成・行動分析）の設計

#### 5-1. タグ生成（`generate_diary_tags` または `save_diary` 内部）

* 入力：

  * 日記本文（数千文字以内を想定）
* プロンプト案：

  * 「次の日記から、短い日本語タグを最大5個、JSON 配列のみで返して下さい。」など
* 出力形式：

  * `["仕事", "集中できた"]` のような JSON 配列
* サーバー処理：

  * JSON パースして、最初の5件を `tag1`〜`tag5` にマッピング

#### 5-2. 行動分析（`run_analysis`）

* 入力データ：

  * 期間内の日記本文（必要に応じて要約）

* プロンプトの考え方：

  * ユーザーのパートナーとして、期間内の行動を冷静に分析し、アドバイスしてください。
* 出力：

  * 今はテキスト 1本（`summary`）だけを返す

---

3. **コピペ用ブロック（最小のひな型）**

#### 3-1. SQLite スキーマ（schema.sql）

```sql
-- diaries: 日記テーブル
CREATE TABLE IF NOT EXISTS diaries (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  date TEXT NOT NULL UNIQUE,              -- YYYY-MM-DD
  content TEXT NOT NULL DEFAULT '',
  tag1 TEXT,
  tag2 TEXT,
  tag3 TEXT,
  tag4 TEXT,
  tag5 TEXT,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);

-- やりたいこと
CREATE TABLE IF NOT EXISTS todos (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  is_done INTEGER NOT NULL DEFAULT 0,     -- 0 = 未完了, 1 = 完了
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);

-- 週間タスク
CREATE TABLE IF NOT EXISTS weekly_tasks (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  week_start_date TEXT NOT NULL,          -- 週の開始日 YYYY-MM-DD
  title TEXT NOT NULL,
  is_done INTEGER NOT NULL DEFAULT 0,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);

-- 行動分析
CREATE TABLE IF NOT EXISTS analyses (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  period_type TEXT NOT NULL,              -- "week" or "month"
  start_date TEXT NOT NULL,
  end_date TEXT NOT NULL,
  summary TEXT NOT NULL,
  created_at TEXT NOT NULL DEFAULT (datetime('now'))
);
```

#### 3-2. TypeScript 型定義（`server/types.ts` 想定）

```ts
export type Diary = {
  id: number;
  date: string;
  content: string;
  tags: string[]; // tag1〜tag5 を配列にまとめて扱う
  created_at: string;
  updated_at: string;
};

export type Todo = {
  id: number;
  title: string;
  is_done: boolean;
  created_at: string;
  updated_at: string;
};

export type WeeklyTask = {
  id: number;
  week_start_date: string;
  title: string;
  is_done: boolean;
  created_at: string;
  updated_at: string;
};

export type Analysis = {
  id: number;
  period_type: "week" | "month";
  start_date: string;
  end_date: string;
  summary: string;
  created_at: string;
};

export type DashboardData = {
  diary: Diary | null;
  todos: Todo[];
  weeklyTasks: WeeklyTask[];
  analysisHistory: Analysis[];
};
```

#### 3-3. MCP ツールの返却形ひな型（TypeScript 関数）

```ts
// structuredContent を統一して返すためのヘルパー
function replyWithDashboard(message: string | null, data: DashboardData) {
  return {
    content: message ? [{ type: "text" as const, text: message }] : [],
    structuredContent: data,
  };
}
```

※ 実際の `registerTool` の書き方は Quickstart の `server.js` と同じパターンです。([OpenAI Developers][1])

---

